name: Build and Publish subconverter-wasm

on:
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      version_increment:
        description: 'ç‰ˆæœ¬æ›´æ–°ç±»å‹ (patch|minor|major)'
        required: false
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
  release:
    types: [created]  # å½“åˆ›å»ºæ–°çš„releaseæ—¶è§¦å‘
  push:
    branches: [main, master]
    paths:
      - 'wasm/**'     # å½“wasmç›®å½•æœ‰å˜æ›´æ—¶è§¦å‘
      - '.github/workflows/publish-wasm.yml'

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown
      
      - name: Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
      
      - name: Cache Rust dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-
      
      - name: Build WASM package
        run: ./build-wasm.sh
      
      - name: Setup version management
        run: npm install -g semver

      - name: Determine version
        id: version
        run: |
          cd pkg
          
          # å°è¯•è·å–å½“å‰ç‰ˆæœ¬
          CURRENT_VERSION=$(node -p "try { require('./package.json').version } catch { '0.1.0' }")
          echo "Current version: $CURRENT_VERSION"
          
          # è·å–å·²å‘å¸ƒçš„æœ€æ–°ç‰ˆæœ¬ï¼ˆå¦‚æœæœ‰ï¼‰
          LATEST_VERSION=$(npm view subconverter-wasm version 2>/dev/null || echo "0.0.0")
          echo "Latest published version: $LATEST_VERSION"
          
          # æ¯”è¾ƒå½“å‰ç‰ˆæœ¬å’Œå·²å‘å¸ƒç‰ˆæœ¬ï¼Œå–æ›´å¤§çš„é‚£ä¸ªä½œä¸ºåŸºç¡€
          BASE_VERSION=$(node -e "console.log(require('semver').gt('$CURRENT_VERSION', '$LATEST_VERSION') ? '$CURRENT_VERSION' : '$LATEST_VERSION')")
          echo "Base version for incrementing: $BASE_VERSION"
          
          # æ ¹æ®è§¦å‘ç±»å‹ç¡®å®šç‰ˆæœ¬å·
          if [[ "${{ github.event_name }}" == "release" ]]; then
            # ä»releaseæ ‡ç­¾æå–ç‰ˆæœ¬ï¼ˆå¦‚æœå­˜åœ¨å¹¶ç¬¦åˆè¯­ä¹‰åŒ–ç‰ˆæœ¬æ ¼å¼ï¼‰
            RELEASE_TAG="${{ github.event.release.tag_name }}"
            if [[ "$RELEASE_TAG" =~ ^v?[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
              # ç§»é™¤å¯èƒ½çš„å‰ç¼€'v'
              RELEASE_VERSION="${RELEASE_TAG#v}"
              echo "Using release tag version: $RELEASE_VERSION"
              NEXT_VERSION="$RELEASE_VERSION"
            else
              # è‡ªåŠ¨å¢åŠ è¡¥ä¸ç‰ˆæœ¬å·
              NEXT_VERSION=$(node -e "console.log(require('semver').inc('$BASE_VERSION', 'patch'))")
              echo "Incrementing to: $NEXT_VERSION (patch)"
            fi
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # æ ¹æ®ç”¨æˆ·è¾“å…¥å¢åŠ ç‰ˆæœ¬å·
            INCREMENT_TYPE="${{ github.event.inputs.version_increment }}"
            NEXT_VERSION=$(node -e "console.log(require('semver').inc('$BASE_VERSION', '$INCREMENT_TYPE'))")
            echo "Incrementing to: $NEXT_VERSION ($INCREMENT_TYPE)"
          else
            # pushè§¦å‘ - ä½¿ç”¨é¢„å‘å¸ƒç‰ˆæœ¬
            # å…ˆå¢åŠ é¢„å‘å¸ƒåŸºç¡€ç‰ˆæœ¬å·
            PRE_VERSION=$(node -e "console.log(require('semver').inc('$BASE_VERSION', 'prerelease', 'beta'))")
            
            # æ·»åŠ æ—¶é—´æˆ³å’Œæäº¤å“ˆå¸Œ
            TIMESTAMP=$(date +%Y%m%d%H%M%S)
            COMMIT_HASH=$(git rev-parse --short HEAD)
            NEXT_VERSION="${PRE_VERSION}.${TIMESTAMP}.${COMMIT_HASH}"
            echo "Creating pre-release version: $NEXT_VERSION"
          fi
          
          # è¾“å‡ºåˆ°åç»­æ­¥éª¤
          echo "NEXT_VERSION=${NEXT_VERSION}" >> $GITHUB_ENV
          echo "version=$NEXT_VERSION" >> $GITHUB_OUTPUT
      
      - name: Create package.json for npm
        run: |
          cd pkg
          
          # ä½¿ç”¨ç¡®å®šçš„ç‰ˆæœ¬å·
          VERSION="${{ env.NEXT_VERSION }}"
          echo "Using version: $VERSION"
          
          # è¯»å–åŸå§‹package.jsonçš„å†…å®¹
          ORIGINAL_PACKAGE=$(cat package.json)
          
          # ä½¿ç”¨jqå·¥å…·æ›´æ–°å¿…è¦çš„å­—æ®µï¼Œä¿ç•™åŸå§‹å†…å®¹
          # å…ˆå®‰è£…jq
          sudo apt-get update && sudo apt-get install -y jq
          
          # æ›´æ–°package.json
          cat package.json | jq \
            --arg version "$VERSION" \
            --arg desc "WebAssembly package for subconverter-rs" \
            --arg repo "https://github.com/lonelam/subconverter-rs" \
            --arg homepage "https://github.com/lonelam/subconverter-rs#readme" \
            --arg author "lonelam" \
          '.version = $version | 
           .description = $desc | 
           .author = $author |
           .license = "MIT" | 
           .repository = {"type": "git", "url": $repo} |
           .homepage = $homepage |
           .keywords = ["wasm", "webassembly", "subconverter", "proxy"] |
           .publishConfig = {"access": "public"} |
           .name = "subconverter-wasm"' > package.json.new
          
          # æ£€æŸ¥ç»“æœï¼Œé¿å…å‡ºé”™
          if [ -s package.json.new ]; then
            mv package.json.new package.json
            echo "Updated package.json:"
            cat package.json
          else
            echo "Error: Failed to update package.json"
            exit 1
          fi
      
      - name: Create README.md for npm package
        run: |
          cd pkg
          
          cat > README.md << EOF
          # subconverter-wasm

          WebAssembly build of [subconverter-rs](https://github.com/lonelam/subconverter-rs) for web browsers and Node.js.

          ## Installation

          ```bash
          npm install subconverter-wasm
          # or
          yarn add subconverter-wasm
          # or
          pnpm add subconverter-wasm
          ```

          ## Usage

          ```js
          import { convert_subscription } from 'subconverter-wasm';

          // å¼‚æ­¥è°ƒç”¨è½¬æ¢å‡½æ•°
          async function convertMySubscription() {
            const result = await convert_subscription('https://example.com/sub', 'clash');
            console.log(result);
          }
          ```

          ## API Reference

          - \`convert_subscription(url: string, target: string): Promise<string>\`: è½¬æ¢è®¢é˜…é“¾æ¥åˆ°ç›®æ ‡æ ¼å¼
          - \`admin_file_exists(path: string): Promise<boolean>\`: æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          - \`admin_read_file(path: string): Promise<string>\`: è¯»å–æ–‡ä»¶å†…å®¹
          - \`admin_write_file(path: string, content: string): Promise<boolean>\`: å†™å…¥æ–‡ä»¶
          - \`list_directory(path: string): Promise<DirectoryEntry[]>\`: åˆ—å‡ºç›®å½•å†…å®¹

          ## Notes

          æ­¤ç‰ˆæœ¬å·: \`${VERSION}\`ï¼Œæ„å»ºäº $(date)
          EOF
      
      - name: Publish to npm
        if: success()
        run: |
          cd pkg
          echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > .npmrc
          
          # å¦‚æœæ˜¯Releaseè§¦å‘æˆ–æ‰‹åŠ¨è§¦å‘ï¼Œåˆ™å‘å¸ƒæ­£å¼ç‰ˆæœ¬
          if [[ "${{ github.event_name }}" == "release" || "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            npm publish
            echo "ğŸ“¦ Published version ${{ env.NEXT_VERSION }} to npm"
          else
            # ä»pushè§¦å‘çš„æ˜¯é¢„å‘å¸ƒç‰ˆæœ¬ï¼Œä½¿ç”¨betaæ ‡ç­¾
            npm publish --tag beta
            echo "ğŸ“¦ Published beta version ${{ env.NEXT_VERSION }} to npm"
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Create git tag for version
        if: success() && (github.event_name == 'release' || github.event_name == 'workflow_dispatch')
        run: |
          # åªä¸ºæ­£å¼ç‰ˆæœ¬åˆ›å»ºgitæ ‡ç­¾
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          VERSION="${{ env.NEXT_VERSION }}"
          
          # åˆ›å»ºæ ‡ç­¾å¹¶æ¨é€
          git tag -a "v${VERSION}" -m "Release v${VERSION}"
          git push origin "v${VERSION}"
          
          echo "ğŸ·ï¸ Created and pushed tag v${VERSION}"

      - name: Notify on Success
        if: success()
        run: |
          echo "âœ… subconverter-wasm v${{ env.NEXT_VERSION }} has been successfully published to npm!"
          
          if [[ "${{ github.event_name }}" == "release" || "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "Published stable version: ${{ env.NEXT_VERSION }}"
          else
            echo "Published beta version: ${{ env.NEXT_VERSION }}"
          fi 